FROM node:18-alpine AS build
WORKDIR /app

COPY frontend/package*.json frontend/tsconfig.json ./
RUN npm install

COPY frontend/. .
RUN npm run build && cp src/index.html dist/

FROM debian:bookworm

RUN apt-get update && \
    apt-get install -y nginx openssl && \
    rm -rf /var/lib/apt/lists/*

RUN rm -f /etc/nginx/sites-enabled/default && \
    mkdir -p /run/nginx /etc/nginx/certs /etc/nginx/conf.d

RUN openssl req -x509 -nodes -newkey rsa:2048 \
    -keyout /etc/nginx/certs/site.key \
    -out /etc/nginx/certs/site.crt \
    -subj "/CN=localhost"

COPY docker/nginx/nginx.conf /etc/nginx/conf.d/default.conf
COPY --from=build /app/dist /usr/share/nginx/html

EXPOSE 80 443

CMD ["nginx", "-g", "daemon off;"]
